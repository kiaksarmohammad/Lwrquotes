{% extends "base.html" %}

{% block title %}Drawing Analysis - LWR{% endblock %}

{% block content %}
<h1>Drawing Analysis</h1>

{% if step == 1 %}
<p>Enter the building address and upload architectural PDF drawings for AI-powered analysis.</p>

<form method="POST" action="/drawing/upload" enctype="multipart/form-data" class="estimate-form">
    <fieldset>
        <legend>Building Address (required)</legend>
        <div class="form-row">
            <label for="address">Commercial Address</label>
            <input type="text" id="address" name="address" required
                   placeholder="e.g. 123 Main St, Calgary, AB"
                   style="width: 100%;">
            <small>Used to get building dimensions from Google Solar API for measurement calibration</small>
        </div>
    </fieldset>

    <fieldset>
        <legend>Drawing PDF (required)</legend>
        <div class="form-row">
            <label for="pdf_file">Architectural Drawing PDF</label>
            <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required>
        </div>
    </fieldset>

    <fieldset>
        <legend>Specification PDF (optional)</legend>
        <div class="form-row">
            <label for="spec_file">Spec Document PDF</label>
            <input type="file" id="spec_file" name="spec_file" accept=".pdf">
        </div>
    </fieldset>

    <button type="submit" class="btn btn-primary">Upload &amp; Continue</button>
</form>

{% elif step == 2 %}
<p>Configure analysis for: <strong>{{ pdf_filename }}</strong> ({{ page_count }} pages)</p>
{% if spec_filename %}
<p>Spec PDF: <strong>{{ spec_filename }}</strong> ({{ spec_page_count }} pages)</p>
{% endif %}

<form method="POST" action="/drawing/measure" class="estimate-form">
    <input type="hidden" name="pdf_path" value="{{ pdf_path }}">
    <input type="hidden" name="spec_path" value="{{ spec_path }}">

    <fieldset>
        <legend>Page Ranges (1-indexed, comma-separated or ranges like 1-3)</legend>
        <div class="form-row">
            <label for="plan_pages">Plan View Pages</label>
            <input type="text" id="plan_pages" name="plan_pages" placeholder="e.g. 2,3" value="{{ suggestions.plan_pages if suggestions else '' }}">
            <small>Pages showing the roof plan view with equipment layout</small>
        </div>
        <div class="form-row">
            <label for="detail_pages">Detail/Section Pages</label>
            <input type="text" id="detail_pages" name="detail_pages" placeholder="e.g. 4,5,6" value="{{ suggestions.detail_pages if suggestions else '' }}">
            <small>Pages showing cross-section details and material assemblies</small>
        </div>
        {% if spec_path %}
        <div class="form-row">
            <label for="spec_pages">Spec Pages</label>
            <input type="text" id="spec_pages" name="spec_pages" placeholder="e.g. 40-45">
            <small>Pages from the specification document</small>
        </div>
        {% else %}
        <input type="hidden" name="spec_pages" value="">
        {% endif %}
    </fieldset>

    <fieldset>
        <legend>Reference Measurement (from Google Maps)</legend>

        {% if dims %}
        <div style="margin: 10px 0; padding: 10px; background: #f0f7ff; border: 1px solid #b3d4fc; border-radius: 4px;">
            <strong>Google Maps dimensions for {{ address }}:</strong><br>
            East-West: {{ dims.width_ft }} ft &nbsp;|&nbsp; North-South: {{ dims.height_ft }} ft
            &nbsp;&mdash;&nbsp; Using longest wall: <strong>{{ dims.longest_wall_ft }} ft ({{ dims.longest_wall_direction }})</strong>
        </div>
        {% elif dims_error %}
        <div style="margin: 10px 0; padding: 10px; background: #fff0f0; border: 1px solid #fcb3b3; border-radius: 4px;">
            <strong>Google Maps lookup failed for {{ address }}:</strong> {{ dims_error }}<br>
            <small>You can enter a reference measurement manually below.</small>
        </div>
        {% endif %}

        <div class="form-row">
            <label for="ref_description">Reference Description</label>
            <input type="text" id="ref_description" name="ref_description"
                   placeholder="e.g. North wall length"
                   value="{{ dims.longest_wall_direction + ' wall (from Google Maps)' if dims else '' }}">
            <small>Auto-filled from Google Maps, or override manually</small>
        </div>
        <div class="form-row">
            <label for="ref_value">Reference Dimension Value</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="ref_value" name="ref_value" step="any"
                       placeholder="e.g. 120" style="flex: 1;"
                       value="{{ dims.longest_wall_ft if dims else '' }}">
                <select id="ref_unit" name="ref_unit" style="width: 100px;">
                    <option value="ft" selected>ft</option>
                    <option value="in">in</option>
                    <option value="m">m</option>
                </select>
            </div>
            <small>Auto-filled from Google Maps, or override manually</small>
        </div>
        <div class="form-row">
            <label for="ref_page">Which page shows this measurement?</label>
            <input type="number" id="ref_page" name="ref_page" min="1" max="{{ page_count }}" placeholder="e.g. 2" value="">
            <small>Leave blank to use the first plan page</small>
        </div>
    </fieldset>

    <div class="alert alert-info">
        The reference measurement will be used to calibrate the AI's dimensional analysis of the plan pages.
    </div>

    <button type="submit" class="btn btn-primary">Auto-Measure & Continue</button>
</form>

{% elif step == 3 %}
<p>Review AI-measured values before final analysis.</p>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<form method="POST" action="/drawing/analyze" class="estimate-form">
    <input type="hidden" name="pdf_path" value="{{ pdf_path }}">
    <input type="hidden" name="spec_path" value="{{ spec_path }}">
    <input type="hidden" name="plan_pages" value="{{ plan_pages }}">
    <input type="hidden" name="detail_pages" value="{{ detail_pages }}">
    <input type="hidden" name="spec_pages" value="{{ spec_pages }}">

    <div class="summary-bar">
        <div class="summary-item">
            <span class="label">Scale Found</span>
            <span class="value">{{ measurements.scale }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Confidence</span>
            <span class="value">
                <span class="tag tag-{{ measurements.confidence|lower }}">{{ measurements.confidence|upper }}</span>
            </span>
        </div>
    </div>

    {% if measurements.notes %}
    <div class="alert alert-info">
        <strong>AI Notes:</strong> {{ measurements.notes }}
    </div>
    {% endif %}

    <fieldset>
        <legend>Roof Measurements (Verify & Edit)</legend>
        <div class="form-row">
            <label for="total_roof_area">Total Roof Area (sqft)</label>
            <input type="number" id="total_roof_area" name="total_roof_area" step="any" value="{{ measurements.total_roof_area_sqft }}" required>
        </div>
        <div class="form-row">
            <label for="perimeter_lf">Roof Perimeter (LF)</label>
            <input type="number" id="perimeter_lf" name="perimeter_lf" step="any" value="{{ measurements.perimeter_lf }}" required>
        </div>
        <div class="form-row">
            <label for="parapet_length_lf">Parapet Length (LF)</label>
            <input type="number" id="parapet_length_lf" name="parapet_length_lf" step="any" value="{{ measurements.parapet_length_lf }}" placeholder="Defaults to perimeter">
        </div>
        <div class="form-row">
            <label for="parapet_height_ft">Parapet Height (ft)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="parapet_height_ft" name="parapet_height_ft" step="any" value="{{ parapet_height.parapet_height_ft }}">
                <span class="tag tag-{{ parapet_height.confidence|lower }}">{{ parapet_height.confidence|upper }}</span>
            </div>
            <small>AI Note: {{ parapet_height.notes }}</small>
        </div>
    </fieldset>

    <div class="alert alert-info">
        Next step: Full analysis of details and item counts using Gemini Vision AI.
    </div>

    <button type="submit" class="btn btn-primary">Confirm & Analyze</button>
</form>
{% endif %}
{% endblock %}
