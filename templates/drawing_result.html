{% extends "base.html" %}

{% block title %}Drawing Analysis Results - LWR{% endblock %}

{% block content %}
<h1>Drawing Analysis Results</h1>

{% if error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
<a href="/drawing" class="btn">Try Again</a>

{% else %}

<!-- AI Analysis Summary -->
{% if analysis %}
<h2>AI Analysis Summary</h2>

{% for plan in analysis.plan_analysis %}
{% if not plan.parse_error %}
<div class="detail-card">
    <h3>Plan View: {{ plan.drawing_ref | default("?") }} (page {{ plan.source_page }})</h3>
    {% if plan.scale %}<p>Scale: {{ plan.scale }}</p>{% endif %}
    {% set counts = plan.counts | default({}) %}
    {% set nonzero = {} %}
    {% for k, v in counts.items() if v > 0 %}
    <span class="tag">{{ k }}: {{ v }}</span>
    {% endfor %}
    {% if plan.detail_references %}
    <p><small>Detail refs: {{ plan.detail_references | join(", ") }}</small></p>
    {% endif %}
</div>
{% endif %}
{% endfor %}

{% for detail_page in analysis.detail_analysis %}
{% if not detail_page.parse_error %}
<div class="detail-card">
    <h3>Details: {{ detail_page.drawing_ref | default("?") }} (page {{ detail_page.source_page }})</h3>
    {% for d in detail_page.details | default([]) %}
    <div class="detail-sub">
        <strong>{{ d.detail_name }}</strong> [{{ d.detail_type }}] - measured in: {{ d.measurement_type | default("?") }}
        <ul>
        {% for layer in d.layers | default([]) %}
            <li>{{ layer.position }}. {{ layer.material }} &rarr; {{ layer.pricing_key }}
                {% if layer.notes %}<small>({{ layer.notes }})</small>{% endif %}
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endfor %}

{% endif %}

<!-- Spec PDF Extraction Results (file_extractor.py) -->
{% if spec_result %}
<h2>Specification PDF Analysis <small style="font-size:0.6em; font-weight:normal; color:#6c757d;">(Deterministic Regex Engine)</small></h2>

{% set proj = spec_result.project_info %}
{% set summary = spec_result.summary %}
<div class="detail-card">
    <p>
        <strong>{{ summary.total_unique_products }}</strong> unique products found across
        <strong>{{ summary.total_categories }}</strong> categories &mdash;
        <strong>{{ summary.total_confirmed_pricing_keys }}</strong> mapped to pricing keys.
    </p>
    {% if proj.project_name %}<p><strong>Project:</strong> {{ proj.project_name }}</p>{% endif %}
    {% if proj.address %}<p><strong>Address:</strong> {{ proj.address }}</p>{% endif %}

    {% for category, prods in spec_result.products.items() %}
    <details style="margin-top:0.5rem;">
        <summary style="cursor:pointer; font-weight:600;">{{ category }} ({{ prods | length }})</summary>
        <ul style="margin:0.4rem 0 0.4rem 1.2rem;">
        {% for pname, info in prods.items() %}
            <li>
                <strong>{{ pname }}</strong>
                {% if info.dimensions %}
                <em style="color:#888;">({{ info.dimensions | join(", ") }})</em>
                {% endif %}
                {% if info.pricing_key %}
                &rarr; <code>{{ info.pricing_key }}</code>
                {% else %}
                &rarr; <span style="color:#c0392b;">no pricing key</span>
                {% endif %}
                <small style="color:#999;">pg {{ info.pages | join(", ") }} &bull; {{ info.mention_count }}x</small>
            </li>
        {% endfor %}
        </ul>
    </details>
    {% endfor %}
</div>
{% endif %}

<!-- ================================================================ -->
<!-- Spec-Driven Pricing (join_takeoff_data: spatial + spec combined)  -->
<!-- ================================================================ -->
{% if joined_estimate %}
<h2>Spec-Driven Pricing Estimate
    <small style="font-size:0.6em; font-weight:normal; color:#6c757d;">
        (Drawing spatial data &plus; Specification materials &mdash; deterministic)
    </small>
</h2>

{% set jbid = joined_estimate.bid_summary %}
<div class="summary-bar">
    <div class="summary-item">
        <span class="label">Line Items Resolved</span>
        <span class="value">{{ jbid.total_line_items }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Resolution Failures</span>
        {% if jbid.total_failures > 0 %}
        <span class="value" style="color:#c0392b;">{{ jbid.total_failures }}</span>
        {% else %}
        <span class="value">{{ jbid.total_failures }}</span>
        {% endif %}
    </div>
    <div class="summary-item">
        <span class="label">Total Material Cost</span>
        <span class="value">{{ jbid.total_material_cost | currency }}</span>
    </div>
</div>

{% if joined_estimate.resolved_line_items %}
<div class="detail-card">
    <h3>Resolved Line Items</h3>
    <table class="results-table">
        <thead>
            <tr>
                <th>Detail</th>
                <th>Type</th>
                <th>Confirmed Material</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Line Cost</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody>
        {% for item in joined_estimate.resolved_line_items %}
            <tr>
                <td>
                    {{ item.detail_name }}
                    <br><small style="color:#888;">{{ item.drawing_ref }}</small>
                </td>
                <td><span class="tag">{{ item.detail_type }}</span></td>
                <td>
                    {{ item.material_name }}
                    <br><small><code>{{ item.pricing_key }}</code></small>
                    {% if item.spec_pages %}
                    <br><small style="color:#888;">spec pg {{ item.spec_pages | join(", ") }}</small>
                    {% endif %}
                </td>
                <td>{{ item.quantity }} {{ item.unit }}</td>
                <td>{{ item.unit_price | currency }}</td>
                <td>{{ item.line_cost | currency }}</td>
                <td><span class="tag tag-small">{{ item.quantity_source[:3] | upper }}</span></td>
            </tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="5" style="text-align:right; font-weight:600;">Total Material Cost</td>
                <td colspan="2" style="font-weight:600;">{{ jbid.total_material_cost | currency }}</td>
            </tr>
        </tfoot>
    </table>
</div>
{% endif %}

{% if joined_estimate.material_failures %}
<div class="detail-card" style="border-left: 4px solid #e74c3c;">
    <h3 style="color:#c0392b;">&#9888; Material Resolution Failures ({{ jbid.total_failures }})</h3>
    <p style="color:#555; font-size:0.9em;">
        These drawing details could not be matched to a confirmed material in the Specification PDF.
        Either the spec PDF does not cover these items, or additional regex patterns are needed in
        <code>database.PRODUCT_KEYWORDS</code>.
    </p>
    <ul>
    {% for failure in joined_estimate.material_failures %}
        <li style="margin-bottom:0.6rem;">
            <strong>{{ failure.detail_name }}</strong>
            <span class="tag">{{ failure.detail_type }}</span>
            <span style="color:#888; font-size:0.85em;">(ref: {{ failure.drawing_ref }})</span>
            <br>
            <small style="color:#888;">
                Expected one of:
                {% for k in failure.expected_pricing_keys %}
                <code>{{ k }}</code>{% if not loop.last %}, {% endif %}
                {% endfor %}
                &mdash; none confirmed in spec.
            </small>
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

{% endif %}
<!-- /Spec-Driven Pricing -->

<!-- Detail-Based Takeoff -->
{% if detail_estimate and detail_estimate.details %}
<h2>Detail-Based Quantity Takeoff (AI-Analyzed)</h2>

{% set meas = detail_estimate.project_measurements %}
<div class="summary-bar">
    <div class="summary-item">
        <span class="label">Roof Area</span>
        <span class="value">{{ meas.total_roof_area_sqft | number }} sqft</span>
    </div>
    <div class="summary-item">
        <span class="label">Perimeter</span>
        <span class="value">{{ meas.perimeter_lf | number }} LF</span>
    </div>
    <div class="summary-item">
        <span class="label">Parapet</span>
        <span class="value">{{ meas.parapet_length_lf | number }} LF x {{ meas.parapet_height_ft }} ft</span>
    </div>
    <div class="summary-item">
        <span class="label">Penetrations</span>
        <span class="value">{{ meas.total_penetrations }}</span>
    </div>
</div>

{% for detail in detail_estimate.details %}
<div class="detail-card{% if detail._is_alternative %} alternative{% endif %}">
    <h3>{{ detail.detail_name }} [{{ detail.detail_type }}]
        <small>(ref: {{ detail.drawing_ref | default("?") }})</small>
        {% if detail._is_alternative %}<span class="tag" style="background:#f0ad4e;color:#fff;margin-left:8px;">Alternative â€” not priced</span>{% endif %}
    </h3>
    <p>Measured in: {{ detail.measurement_type }} | Base value: {{ "{:,}".format(detail.base_measurement) }} | Detail cost: {{ detail.detail_cost | currency }}
        {% if detail.quantity_source %}<span class="tag">qty: {{ detail.quantity_source }}</span>{% endif %}
    </p>
    {% if detail.warning %}
    <div class="alert alert-warning"><small>{{ detail.warning }}</small></div>
    {% endif %}

    <table class="results-table">
        <thead>
            <tr>
                <th>Material</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Line Cost</th>
            </tr>
        </thead>
        <tbody>
            {% for layer in detail.layers %}
            <tr>
                <td>
                    {{ layer.material }}
                    {% if layer.warning %}<br><small class="warning">{{ layer.warning }}</small>{% endif %}
                    {% if layer.notes %}<br><small class="note">({{ layer.notes }})</small>{% endif %}
                </td>
                <td>{% if layer.units_needed is defined %}{{ layer.units_needed }} {{ layer.unit }}{% elif layer.quantity is defined and layer.quantity != "?" %}{{ layer.quantity }} {{ layer.unit }}{% else %}?{% endif %}</td>
                <td>{{ layer.unit_price | currency }}</td>
                <td>{% if layer.layer_cost is defined and layer.layer_cost > 0 %}{{ layer.layer_cost | currency }}{% elif layer.line_cost is defined and layer.line_cost > 0 %}{{ layer.line_cost | currency }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}

<!-- Bid Summary -->
{% set bid = detail_estimate.bid_summary %}
{% if bid %}
<div class="bid-summary">
    <div class="bid-total">
        <span class="label">Total Material Cost</span>
        <span class="value">{{ bid.material_cost | currency }}</span>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Standard Estimate for Comparison -->
{% if standard_estimate %}
<h2>Standard Estimate (for comparison)</h2>
{% set sbid = standard_estimate.bid_summary %}
<div class="bid-summary">
    <div class="bid-total">
        <span class="label">Standard Total Estimate</span>
        <span class="value">{{ sbid.total_estimate | currency }}</span>
    </div>
</div>
{% endif %}

<div class="actions">
    <a href="/drawing" class="btn">New Analysis</a>
    <button onclick="window.print()" class="btn btn-secondary">Print</button>
</div>

{% endif %}
{% endblock %}
